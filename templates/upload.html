{% extends "base.html" %}

{% block title %}Upload Your GRM File{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body p-5 text-center" id="uploadCardBody">
        <img src="{{ url_for('static', filename='images/GRM_Extractor.jpg') }}" alt="GRM Extractor Banner" class="img-fluid w-100 d-block mx-auto mb-4" style="max-width: 350px;">
        <!-- <h1 class="card-title">Guild Roster Manager - Log Extractor</h1> -->
        <p class="lead text-muted">Upload your WoW Addon Saved Variables file to begin.<br>(<code>Guild_Roster_Manager.lua</code>)</p>

        <div class="mt-4">
            <p>Drag & Drop your .lua file anywhere in this box</p>
            <p class="text-muted">or Click to Browse</p>
        </div>
    </div>
</div>

<div id="processingIndicator" style="display: none;" class="text-center mt-4">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Processing your file, please wait...</p>
</div>

<form method="POST" enctype="multipart/form-data" id="uploadForm">
    <input type="file" name="file" id="fileInput" accept=".lua" required hidden>
</form>

<script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const uploadCardBody = document.getElementById('uploadCardBody');
    const processingIndicator = document.getElementById('processingIndicator');

    window.addEventListener('pageshow', function(event) {
        // Reset the UI to its initial state
        document.querySelector('.card').style.display = 'block';
        processingIndicator.style.display = 'none';
        // Clear the file input in case a file was selected before navigating away
        fileInput.value = '';
    });

    // Function to submit form and show indicator
    function handleFileUpload() {
        if (fileInput.files.length > 0) {
            document.querySelector('.card').style.display = 'none'; // Hide the card
            processingIndicator.style.display = 'block'; // Show spinner
            form.submit();
        }
    }

    // Clicking anywhere on the card body triggers the hidden file input
    uploadCardBody.addEventListener('click', () => {
        fileInput.click();
    });

    // Auto-submit when a file is chosen via the browser dialog
    fileInput.addEventListener('change', handleFileUpload);

    // --- Drag and Drop Logic (now on the card body) ---
    uploadCardBody.addEventListener('dragover', (e) => {
        e.preventDefault();
        // Add visual cue only if a file is being dragged over
        if (e.dataTransfer.types.includes('Files')) {
            uploadCardBody.classList.add('drag-over');
        }
    });

    uploadCardBody.addEventListener('dragleave', () => {
        uploadCardBody.classList.remove('drag-over');
    });

    uploadCardBody.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadCardBody.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileUpload(); // Auto-submit on drop
        }
    });
</script>
{% endblock %}